<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.tp.admin.dao.PartnerDao">

    <select id="findById" resultMap="PartnerMap">
        SELECT
        p.*
        FROM
        partner AS p INNER JOIN partner_details AS pd ON p.id = pd.partner_id
        WHERE
        p.id = #{id}
        LIMIT 0 , 1
    </select>

    <select id="listBySearch" parameterType="com.tp.admin.data.search.PartnerSearch" resultMap="PartnerMap">
        SELECT
        p.*
        FROM
        partner AS p INNER JOIN partner_details AS pd ON p.id = pd.partner_id
        ORDER BY id DESC
        <if test="pageSize != null and pageSize !=0 and offset != null">
            LIMIT #{offset},#{pageSize}
        </if>
    </select>

    <select id="cntBySearch" parameterType="com.tp.admin.data.search.PartnerSearch" resultType="java.lang.Integer">
        SELECT
        COUNT(p.id)
        FROM
        partner AS p INNER JOIN partner_details AS pd ON p.id = pd.partner_id
    </select>
    
    <select id="partnerWashCardIdSearch" parameterType="java.lang.Integer" resultMap="PartnerWashCardMap">
        SELECT id,name
        FROM partner_wash_card
        WHERE create_partner_id=#{createPartnerId}
    </select>

    <select id="listPartnerUserWashCardDTOBySearch" parameterType="com.tp.admin.data.parameter.WxMiniSearch"
            resultMap="PartnerWashCardUserDTOMap">
        SELECT
        u.id,
        u.phone,
        ui.nickname,
        ui.avatar ,
        ui.city,
        u.type,
        wash_card.name,
        wash_card.cnt,
        wash_card.id AS partner_card_id,
        wash_card.type AS wash_card_type,
        card_order.id AS user_wash_card_id
        FROM
        `partner_wash_card_order` AS card_order
        INNER JOIN `user` AS u ON u.id = card_order.user_id
        INNER JOIN `user_info` AS ui ON ui.user_id = card_order.user_id
        INNER JOIN partner_wash_card AS wash_card ON card_order.partner_card_id=wash_card.id
        WHERE
        card_order.partner_card_id IN
        <foreach collection="ids" index="index" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
        <if test="userType != null">
            AND u.type = #{userType}
        </if>
        <if test="washCardType != null">
            AND wash_card.type = #{washCardType}
        </if>
        GROUP BY u.id
        ORDER BY u.id DESC
        <if test="pageSize != null and pageSize !=0 and offset != null">
            LIMIT #{offset},#{pageSize}
        </if>
    </select>

    <select id="cntPartnerUserWashCardDTOBySearch" parameterType="com.tp.admin.data.parameter.WxMiniSearch" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM
        `partner_wash_card_order` AS card_order
        INNER JOIN `user` AS u ON u.id = card_order.user_id
        INNER JOIN `user_info` AS ui ON ui.user_id = card_order.user_id
        INNER JOIN partner_wash_card AS wash_card ON card_order.partner_card_id=wash_card.id
        <where>
        card_order.partner_card_id IN
        <foreach collection="ids" index="index" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
        <if test="userType != null">
            AND u.type = #{userType}
        </if>
        <if test="washCardType != null">
            AND wash_card.type = #{washCardType}
        </if>
        </where>
    </select>

    <select id="findPartnerLevelById" resultType="java.lang.Integer">
      SELECT
      pd.partner_level
      FROM
      `partner` AS p INNER JOIN `partner_details` AS pd ON p.id = pd.partner_id
      WHERE
      p.id = #{id}
    </select>

    <resultMap id="PartnerMap" type="com.tp.admin.data.entity.Partner">
        <id column="id" property="id" jdbcType="INTEGER" />
        <result column="name" property="name" jdbcType="VARCHAR" />
        <result column="pw" property="pw" jdbcType="VARCHAR" />
        <result column="intros" property="intros" jdbcType="VARCHAR" />
        <result column="contract" property="contract" jdbcType="VARCHAR" />
        <result column="title" property="title" jdbcType="VARCHAR" />
        <result column="deleted" property="deleted" jdbcType="BIT" />
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
        <result column="last_login_time" property="lastLoginTime" jdbcType="TIMESTAMP" />
    </resultMap>
    <resultMap id="PartnerWashCardMap" type="com.tp.admin.data.dto.PartnerWashCardDTO">
        <id column="id" property="id" jdbcType="INTEGER" />
        <result column="name" property="name" jdbcType="VARCHAR" />
    </resultMap>


    <resultMap id="PartnerWashCardUserDTOMap" type="com.tp.admin.data.dto.PartnerUserWashCardDTO">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="phone" property="phone" jdbcType="VARCHAR"/>
        <result column="nickname" property="nickName" jdbcType="VARCHAR"/>
        <result column="avatar" property="avatar" jdbcType="VARCHAR"/>
        <result column="city" property="city" jdbcType="VARCHAR"/>
        <result column="type" property="type" jdbcType="INTEGER"/>
        <result column="cnt" property="cnt" jdbcType="INTEGER"/>
        <result column="partner_card_id" property="partnerCardId" jdbcType="INTEGER"/>
        <result column="wash_card_type" property="washCardType" jdbcType="INTEGER"/>
        <result column="user_wash_card_id" property="userWashCardId" jdbcType="INTEGER"/>
        <result column="name" property="washCardName" jdbcType="VARCHAR"/>
    </resultMap>

</mapper>