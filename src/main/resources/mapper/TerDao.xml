<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.tp.admin.dao.TerDao">


	<select id="findAllTerIdAndTitle" resultType="java.util.Map">
        SELECT t.id ,t.`code`, ti.title
 		FROM
		ter AS t INNER JOIN ter_info AS ti ON t.id = ter_id
		WHERE
		t.deleted = 0
    </select>



	<select id="findAllTerInfoCount" resultType="java.lang.Integer">
		SELECT COUNT(tt.id)
 		FROM
		(SELECT t.id , ti.title,t.`code`FROM ter AS t INNER JOIN ter_info AS ti ON t.id = ter_id
		WHERE
		t.deleted = 0) tt
	</select>

    <select id="listTerCityId" resultType="java.lang.Integer">
        SELECT
		city
		FROM
		ter AS t
		GROUP BY t.city
    </select>

    <select id="terInfoSearch" parameterType="com.tp.admin.data.parameter.WxMiniSearch" resultMap="TerInfoDTOMap">
		SELECT
		t.id ,
		ti.online ,
		ti.title ,
		ti.status ,
		ti.cover ,
		ti.address ,
		ti.geo_code ,
		t.code
		FROM
		ter AS t INNER JOIN ter_info AS ti ON t.id = ti.ter_id
		WHERE
		ti.deleted = 0
		<if test="terId !=null and terId != 0">
			AND t.id = #{terId}
		</if>
		<if test="cityCode !=null and cityCode != 0">
			AND t.city = #{cityCode}
		</if>
		<if test="online != null">
			AND ti.online = #{online}
		</if>
		<if test="status != null and status == 1">
			AND ti.status = #{status}
		</if>
		<if test="ids != null and ids.size != 0">
			AND
			t.id IN
			<foreach collection="ids" index="index" item="item" separator="," open="(" 			close=")">
				#{item}
			</foreach>
		</if>
		ORDER BY ti.id ASC
		<if test="offset != null and pageSize != null and pageSize != 0">
			LIMIT #{offset},#{pageSize}
		</if>
	</select>

	<select id="cntTerInfoSearch" parameterType="com.tp.admin.data.parameter.WxMiniSearch"
			resultType="java.lang.Integer">
		SELECT
		COUNT(t.id)
		FROM
		ter AS t INNER JOIN ter_info AS ti ON t.id = ti.ter_id
		WHERE
		ti.deleted = 0
		<if test="terId !=null and terId != 0">
			AND t.id = #{terId}
		</if>
		<if test="cityCode !=null and cityCode != 0">
			AND t.city = #{cityCode}
		</if>
		<if test="online != null">
			AND ti.online = #{online}
		</if>
		<if test="status != null and status == 1">
			AND ti.status = #{status}
		</if>
		<if test="ids != null and ids.size != 0">
			AND
			t.id IN
			<foreach collection="ids" index="index" item="item" separator="," open="(" 			close=")">
				#{item}
			</foreach>
		</if>
	</select>

    <select id="findRelatedTerByPartnerId" resultType="java.lang.Integer">
		SELECT tpp.ter_id
		FROM
		ter_pk_partner AS tpp INNER JOIN ter AS t ON tpp.ter_id = t.id
		WHERE
		tpp.partner_id = #{partnerId}
		AND
		tpp.enable = 1
		AND
		t.deleted = 0
	</select>

	<select id="findAllTerProperty" parameterType="com.tp.admin.data.search.TerPropertySearch" resultMap="AdminTerPropertyDTOMap">
		SELECT * FROM admin_ter_property
		WHERE deleted = 0
		<if test="pageSize != null and pageSize !=0 and offset != null">
			LIMIT #{offset},#{pageSize}
		</if>
	</select>

	<select id="findAllTerPropertyCount" resultType="java.lang.Integer">
		SELECT COUNT(atp.id) FROM admin_ter_property AS atp
	</select>

	<select id="findTerStartInfo" parameterType="java.lang.Integer" resultMap="AdminTerPropertyDTOMap">
		SELECT  atp.id,
				atp.ter_id,
				atp.net_method,
				atp.video_control,
				atp.bubble_limit,
				atp.ter_clientversion,
				atp.ter_busi_mode,
				atp.ter_model,
				atp.ter_remark,
				atp.high_limit,
				atp.wide_limit,
				atp.ad_exist,
				atp.screen_wide,
				atp.screen_high
        FROM admin_ter_property AS atp
				WHERE atp.id=#{id}
	</select>


	<update id="updateTerProperty" parameterType="com.tp.admin.data.dto.AdminTerPropertyDTO">
		UPDATE `admin_ter_property`
		<trim prefix="set" suffixOverrides=",">
			<if test="terId != null">
				`ter_id` = #{terId},
			</if>
			<if test="netMethod != null">
				`net_method` = #{netMethod},
			</if>
			<if test="videoControl != null">
				`video_control` = #{videoControl},
			</if>
			<if test="bubbleLimit != null">
				`bubble_limit` = #{bubbleLimit},
			</if>
			<if test="terClientVersion  != null">
				`ter_clientversion` = #{terClientVersion},
			</if>
			<if test="terBusiMode  != null">
				`ter_busi_mode` = #{terBusiMode},
			</if>
			<if test="terModel != null">
				`ter_model` = #{terModel},
			</if>
			<if test="terRemark != null">
				`ter_remark` = #{terRemark},
			</if>
			<if test="highLimit != null">
				`high_limit` = #{highLimit},
			</if>
			<if test="wideLimit != null">
				`wide_limit` = #{wideLimit},
			</if>
			<if test="adExist != null">
				`ad_exist` = #{adExist},
			</if>
			<if test="screenWide != null">
				`screen_wide` = #{screenWide},
			</if>
			<if test="screenHigh != null">
				`screen_high` = #{screenHigh},
			</if>
			<if test="propertyRemark != null">
				`property_remark` = #{propertyRemark},
			</if>
		</trim>
		WHERE
			id=#{id}
	</update>

    <resultMap id="TerInfoDTOMap" type="com.tp.admin.data.dto.TerInfoDTO" >
		<id column="id" property="id" jdbcType="INTEGER" />
		<id column="code" property="code" jdbcType="VARCHAR" />
		<id column="address" property="address" jdbcType="VARCHAR" />
		<id column="geo_code" property="geoCode" jdbcType="VARCHAR" />
		<id column="title" property="title" jdbcType="VARCHAR" />
		<result column="online" property="online" jdbcType="BIT" />
		<result column="status" property="status" jdbcType="SMALLINT" />
	</resultMap>


	<resultMap id="AdminTerPropertyDTOMap" type="com.tp.admin.data.dto.AdminTerPropertyDTO">
		<id column="ter_id" property="terId" javaType="INTEGER"/>
		<result column="net_method" property="netMethod" jdbcType="INTEGER"/>
		<result column="video_control" property="videoControl" jdbcType="VARCHAR"/>
		<result column="bubble_limit" property="bubbleLimit" jdbcType="INTEGER"/>
		<result column="ter_clientversion" property="terClientVersion" jdbcType="VARCHAR"/>
		<result column="ter_busi_mode" property="terBusiMode" jdbcType="INTEGER"/>
		<result column="ter_model" property="terModel" jdbcType="VARCHAR"/>
		<result column="ter_remark" property="terRemark" jdbcType="VARCHAR"/>
		<result column="property_remark" property="propertyRemark" jdbcType="VARCHAR"/>
		<result column="high_limit" property="highLimit" jdbcType="SMALLINT"/>
		<result column="wide_limit" property="wideLimit" jdbcType="SMALLINT"/>
		<result column="ad_exist" property="adExist" jdbcType="BIT"/>
		<result column="screen_wide" property="screenWide" jdbcType="INTEGER"/>
		<result column="screen_high" property="screenHigh" jdbcType="INTEGER"/>
		<result column="device_type" property="deviceType" jdbcType="INTEGER"/>
		<result column="video_picture" property="videoPicture" jdbcType="VARCHAR"/>
	</resultMap>

</mapper>