<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.tp.admin.dao.AdminTerOperatingLogDao">

    <insert id="insert">
        INSERT INTO `admin_ter_operating_log` (
			`ter_id`,
			`maintion_id`,
			`merchant_id`,
			`username`,
			`title`,
			`intros`,
			`type`,
			`op_source`,
			`imgs`,
			`success`,
			`msg`
		) VALUES (
			#{terId},
			#{maintionId},
			#{merchantId},
			#{username},
			#{title},
			#{intros},
			#{type},
			#{opSource},
			#{imgs},
			#{success},
			#{msg}
		)
    </insert>

    <select id="listLogBySearch" resultMap="AdminTerOperatingLogDTOMap">
		SELECT
		log.id ,
		log.title ,
		log.create_time ,
		log.ter_id ,
		log.maintion_id ,
		log.merchant_id ,
		log.username ,
		maintion.name AS maintion_username ,
		merchant.name AS merchant_username ,
		ti.title AS ter_title,
		log.intros ,
		log.type ,
		log.op_source ,
		log.imgs ,
		log.success,
		log.msg
		FROM
		`admin_ter_operating_log` AS log
		INNER JOIN `ter_info` AS ti ON log.ter_id = ti.ter_id
		LEFT JOIN `admin_maintion_employee` AS maintion ON maintion.id = log.maintion_id AND log.op_source = 0
		LEFT JOIN `admin_merchant_employee` AS merchant ON merchant.id = log.merchant_id AND log.op_source = 1
		<where>
			<if test="terId != null">
				log.ter_id = #{terId}
			</if>
			<if test="opSource != null">
				AND log.op_source = #{opSource}
			</if>
			<if test="startTime != null and endTime != null">
				AND log.create_time BETWEEN #{startTime} AND #{endTime}
			</if>
		</where>
		ORDER BY log.create_time DESC
		<if test="pageSize != null and pageSize !=0 and offset != null">
			LIMIT #{offset},#{pageSize}
		</if>
    </select>

    <select id="cntBySearch" resultType="java.lang.Integer">
		SELECT
		COUNT(log.id)
		FROM
		admin_ter_operating_log AS log
			INNER JOIN ter_info AS ti ON log.ter_id = ti.ter_id
		<where>
			<if test="terId != null">
				log.ter_id = #{terId}
			</if>
			<if test="opSource != null">
				AND log.op_source = #{opSource}
			</if>
			<if test="startTime != null and endTime != null">
				AND log.create_time BETWEEN #{startTime} AND #{endTime}
			</if>
		</where>
    </select>


	<resultMap id="AdminTerOperatingLogDTOMap"
			   type="com.tp.admin.data.dto.AdminTerOperatingLogDTO">
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
		<result column="ter_id" property="terId" jdbcType="INTEGER"/>
		<result column="ter_title" property="terTitle" jdbcType="VARCHAR"/>
		<result column="maintion_id" property="maintionId" jdbcType="INTEGER"/>
		<result column="merchant_id" property="merchantId" jdbcType="INTEGER"/>
		<result column="maintion_username" property="maintionUsername" jdbcType="VARCHAR"/>
		<result column="merchant_username" property="merchantUsername" jdbcType="VARCHAR"/>
		<result column="title" property="title" jdbcType="VARCHAR"/>
		<result column="intros" property="intros" jdbcType="VARCHAR"/>
		<result column="type" property="type" jdbcType="INTEGER"/>
		<result column="op_source" property="opSource" jdbcType="INTEGER"/>
		<result column="imgs" property="imgs" jdbcType="INTEGER"/>
		<result column="success" property="success" jdbcType="BIT"/>
		<result column="msg" property="msg" jdbcType="VARCHAR"/>
	</resultMap>

</mapper>