<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.tp.admin.dao.PartnerUserWashCardDao">

    <update id="updateCardInvalid">
      UPDATE `partner_user_wash_card`
      SET invalid = 1
      WHERE
      valid_time &lt;=  #{timestamp}
    </update>


    <update id="addUpdateCnt">
        UPDATE
			`partner_user_wash_card`
		SET
			cnt =
  				( CASE WHEN cnt >= 0
    				THEN  cnt + 1
    				ELSE  0
    			END )
		WHERE
			id = #{id}
			AND
			cntless = 0
    </update>


    <update id="updateCardInvalidByCnt">
        UPDATE
          `partner_user_wash_card`
        SET invalid = 1
        WHERE
        cnt = 0
        AND
		cntless = 0
    </update>

    <update id="recoveryCardInvalid">
        UPDATE
          `partner_user_wash_card`
          SET invalid = 0
          WHERE
          id = #{id}
          AND
          cntless = 0
    </update>

    <select id="findById" resultMap="PartnerUserWashCardDetailDTOMap">
      SELECT
          user_wash_card.* ,
          wash_card.name ,
          wash_card_logo.id AS logo_id ,
          wash_card_logo.logo ,
          wash_card_logo.font_color ,
          p.title AS create_partner_name
      FROM
          `partner_user_wash_card` AS user_wash_card
          INNER JOIN `partner_wash_card` AS wash_card ON wash_card.id = user_wash_card.partner_card_id
          INNER JOIN `partner_wash_card_logo` AS wash_card_logo ON wash_card_logo.id = wash_card.logo_id
          INNER JOIN `partner_wash_card_pk_ter` AS wash_card_pk_ter ON wash_card_pk_ter.wash_card_id = wash_card.id
          INNER JOIN `partner` AS p ON p.id = user_wash_card.partner_id
      WHERE
          user_wash_card.id = #{id}
          AND
          wash_card_pk_ter.enable = 1
          AND
          wash_card_pk_ter.deleted = 0
          GROUP BY user_wash_card.id
    </select>

    <resultMap id="PartnerUserWashCardDetailDTOMap" type="com.tp.admin.data.dto.PartnerUserWashCardDetailDTO">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <id column="partner_card_id" property="partnerCardId" jdbcType="INTEGER"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="valid_time" property="validTime" jdbcType="TIMESTAMP"/>
        <result column="invalid" property="invalid" jdbcType="BIT"/>
        <result column="logo_id" property="logoId" jdbcType="INTEGER"/>
        <result column="logo" property="logo" jdbcType="VARCHAR"/>
        <result column="font_color" property="fontColor" jdbcType="VARCHAR"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="type" property="type" jdbcType="INTEGER"/>
        <result column="cnt" property="cnt" jdbcType="INTEGER"/>
        <result column="cntless" property="cntLess" jdbcType="BIT"/>
        <result column="final_price" property="finalPrice" jdbcType="INTEGER"/>
        <result column="discount" property="discount" jdbcType="INTEGER"/>
        <result column="create_partner_name" property="createPartnerName" jdbcType="VARCHAR"/>
    </resultMap>


</mapper>